# Ceph

Ceph 是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。

## 01 配置导入导出

1. 操作菜单：导出配置文件、从配置文件恢复系统。
2. 配置文件模块：节点、集群、数据分布规则、存储池、缓冲池、MDS、文件系统、高可用、本地用户、AD 用户、NFS、CIFS。
3. 配置文件展示是 key/value 的 json 文件，value 只展开一级，如果 value 还是对象或者数组，不再做格式化处理展开，而是以字符串展示。
4. 从配置文件恢复系统可以验证配置文件是否正确，有三种状态：验证中、验证成功、验证失败。
5. 配置校验和配置恢复是按模块依次进行的。

## 02 磁盘更换

1. 只有 maintainer 角色才允许进行磁盘更换
2. 磁盘有四种状态：up、down、in、out
3. 磁盘更换步骤：
   1. 进行点亮磁盘灯操作
   2. 进行检测磁盘更换情况
   3. 禁用数据平衡
   4. 创建 OSD 阶段
   5. 数据恢复
   6. 替换 OSD 数据分布规则阶段
   7. 残留磁盘信息清理阶段
   8. 数据分布规则重建

## 03 存储池

### 数据分布规则

1. 数据分布规则（故障域规则 crush rule），crush 算法实现了 ceph 集群的去中心化，这也是 ceph 实现分布式的关键。
2. 数据分布规则为用户自定义的数据映射的策略。它决定了客户端的数据的写入和读取的位置。
3. 故障域级别：机柜、节点、磁盘，状态：如果是 osd 则展示 in/out、up/down 四种状态的两种，否则展示配置已生效和配置未生效。
4. 资源：ID、节点名称、存储设备、磁盘类型、容量。
5. refresh_osd 只在第一次进入时执行刷新 osd 的操作，减少请求响应时间，接口获取的规则列表是一级的，需要根据 parentId 做处理成树结构，这样可以多层展开。
6. 添加规则：0 是 osd，1 是节点，2 是机柜。

### 存储池

1. 池是 ceph 存储集群的逻辑分区，用于存储对象。对象存储到池中时，使用数据分布规则将对象分配到池中的一个 PG（placement group 归置组），PG 根据池的配置和数据分布规则自动映射一组 OSD。
2. 存储池支持的三种存储用途：块存储、文件存储、对象存储、元数据。
3. 存储池状态：已使用、未使用、异常，14xC 新增两种状态：销毁中和已销毁，销毁中的存储池不可删除和修改，已销毁的存储池可以删除。
4. 纠删码和副本：
   - 副本，一个数据拷贝多份完全一样的副本，分别存放在多个不同节点或磁盘上，N 个副本至少需要 N 个节点才能部署，比如 2 副本至少需要 2 个存储节点。
   - 纠删码 K+M，K 是数据盘，M 是校验盘，K+M 纠删码至少需要（K+M）个节点，比如 2+1 纠删码至少需要 3 个节点。
   - 副本磁盘空间的利用率低，而纠删码具有更高的磁盘利用率，但是读性能低。

### 缓冲池（暂时略过）

所谓的缓存分层其实就是在更快的磁盘（通常是 ssd）上创建一个存储池。然后将这个存储池放置在常规的复制池或者纠删码池的前端充当缓存。这样所有的客户端 I/O 操作都首先由缓存池处理，之后再将数据写回到现有的数据存储池中，使得客户端能够在缓存池上享受更好的性能，而最终数据还是写回到常规池中。

缓存池能以以下两种模式进行配置：

- writeback 模式：当缓存池配置为 writeback 模式时，客户端将数据写至缓存池，然后立即接收写入确认。缓存池基于我们为其设置的 flushing/evicting 策略，将数据从缓存池迁移至后端存储池，并最终由缓存代理将其从缓存层中删除。处理来自客户端的读操作时，首先由缓存分层代理将数据从存储层迁移至缓存层，然后再将其返回给客户端。只到数据变得不再活跃或者成为冷数据时，再将其从缓存池中删除。
- read-only 模式：当缓存池配置为 read-only 模式时，它只适用于处理客户端的读操作。客户端的写操作不涉及缓存分层，所有的客户端写都在存储层上完成。在处理来自客户端的读操作时，缓存分层代理将请求的数据从存储层复制到缓存层。缓存池基于我们为其配置的策略，将不活跃的对象从缓存池中删除。这种方法非常适合多个客户端需要读取大量类似数据的场景。

## 04 对象

### 对象服务

1. 对象存储通过 ceph 对象存储网关提供对象存储接口，也称为 RGW 接口。RGW 为应用程序提供了一个 RESTful S3/swift 兼容的接口，用于在 ceph 集群中以对象的形式存储数据。
2. RGW 对外的三类基础数据逻辑实体：用户、存储桶、对象。
3. 对象服务初始化流程：网络管理中创建网络类型为业务网络的网口 -> 创建对象池（数据池、索引池、扩展池）-> 对象服务初始化（完成 zone、zonegroup 创建与对象网关创建）。
4. 多站点初始化与对象服务初始化类似，不同点是需要在每个站点上进行初始化，且在初始化时选定当前站点的角色，从站点还需要配置主站点地址。
5. 站点初始化
   - 选择是否启用 ssl 连接，自动选择 8080/443 端口，选择是 https/http 协议验证主机群网关
   - 多站点初始化需要选择角色是主/从
   - 站点初始化数据池/索引池/扩展池三个池需要互斥，不能选择同一个池
   - 主站点直接可以初始化，从站点需要验证主集群网关是否可以连接
6. 对象搜索是基于实时搜索引擎 Elasticsearch 实现的，需要配置索引池、节点和端口。
7. 小文件聚合，开启后小文件会自动合并成大文件，提升对象读写效率。
8. 站点状态：启用、停用、异常

### 多站点

1. 菜单：切换角色、检查一致性、设置站点属性、刷新。
   - 切换站点角色是通过从站点发送请求，主站点不能切换；一致性检查只针对从站点做一致性检查
   - 检查一致性需要选择的站点数量大于 1 个，而且主站点默认是一致的
   - 设置站点属性只有从站点可以设置属性
2. 多站点的同步状态：同步完成、同步中、同步异常。
3. 侧边栏基本信息：多站点的基本信息、集群名称、角色（主站点、备站点）、是否只读、状态（同步中、已同步，只有非主节点显示同步信息）、访问 URL、连接状态（连接中、断开连接）。
4. 同步状态：滞后数量、未同步旧数据的时间、全量同步、增量同步的进度。
5. 主站点可以将其它站点移除、从站点可以将自己移除。

### S3 用户

S3 用户是新建的对象存储服务用户，包含用户名、密钥、授权信息，每个用户只能访问或者操作已经授权的存储资源。

用户数据信息：

- 用户认证信息: S3（access key,secret key）
- 访问控制权限信息: 包含操作访问权限（read、write、delete 等）和访问控制列表
- 用户配额信息: 防止某些用户占用过多存储空间，根据用户付费情况配置存储空间

Ceph 早期版本中，集群中不允许有同名的 user/bucket，这可能在实际使用过程中带来某些不便。后期 ceph 引入多租户的概念，将同名 user/bucket 隔离在不同的租户（tenant）下，使同一集群中可创建同名 user/bucket。每个 user/bucket 都位于一个租户下，相互隔离，各不影响。

为了兼容版本，ceph 引入隐式空字符串 "" 租户，如果创建用户不显式指定租户则默认加入 "" 租户中。

租户可以批量删除，已经创建过用户的租户不可删除。不可创建同名的租户。

### 存储桶

桶是用户存储对象的存储空间，具备独立的配额，一个桶必须且只属于一个用户，但是可以允许其他用户访问。

1. 新建桶
   - 分两步：首先配置桶名称、拥有者和对象策略，再配置桶的配额，桶拥有者支持远程搜索
   - ACL 权限：公共权限、用户权限、混合权限
   - 多版本和 worm 互斥
   - 开启多版本后，桶内已存在的对象新写入或修改后将以多个版本的形式保存再系统中
   - 开启 worm 后，桶内的对象不允许被修改和删除操作
2. 新建桶策略：被授权人、效应、权限、资源（桶全部、指定桶对象），之前提到过一个桶必须且只属于一个用户，但是可以允许其他用户访问，这个其他用户就是被授权人，可以决定被授权人对桶内对象的访问权限，可以指定桶全部、指定桶对象
3. 生命周期规则：在某个时间节点后或者过一段时间后，对桶内对象执行的某些操作：执行转为归档存储、低频存储或者删除，可以针对桶内全部对象或者以某一前缀命名的对象
4. 桶日志：对对象有一些操作，将操作日志写到哪个桶里面，可以指定桶
5. NFS 共享，表单：网关节点、受限客户端、是否开启，如果存储桶已存在多版本对象，NFS 网关只会读取最新版本的数据。老版本的对象数据可以通过对象路由方式访问。

### 对象策略

对象策略是一组关于资源分配来源、数据存储形式、数据复制的规则。

1. 存储类型：标准存储、低频存储、归档存储
2. 压缩算法：lz4、snappy、zlib、zstd
3. 数据池、索引池、扩展池必须互斥，不能选用同一个池
4. 提交时，对于数据池，需要添加标准存储类型的存储池
5. 已被使用的对象策略只能增加存储类型，不能做其他修改

### 对象

1. 分两栏：左侧是保存的搜索模板、右侧是搜索栏目
2. 搜索可以简单搜索和高级搜索，可以保存搜索模板，点击模板时候就可以搜索表单填充，方便搜索
   - 简单搜索：对象名、桶名
   - 高级搜索：对象大小、标签、所属用户、更新时间。tag 只是简单的 key/value 格式，限制 tag 数目最多为 10 个，设置 10 个后不能继续添加，需要判断是否存在，再去获取详细信息
3. 操作菜单：ACL 权限管理、多版本管理、保护期管理、删除和下载对象
4. ACL 权限管理：公共用户、指定用户、继承桶；
   - 公共用户：私有、公共读、公共读写
   - 指定用户：仅读取、仅写入、所有权限
5. 保护期管理：对象只在初始化时会继承所属桶的 worm 参数，一旦修改参数互不影响
   - 遵从模式：一般模式（部分用户不能重写或删除对象）、严格模式（任何用户均无法重写或删除对象）
6. 详情：所属桶、拥有者、对象拥有者的状态
7. 对象 worm 保护期时间有限制，而且如果重新设置时间不能比旧时间更短

### nfs

一个桶必须且只属于一个用户，但是可以允许其他用户访问，可以创建 nfs 共享来允许其他用户访问。

1. nfs 共享需要两步：
   - 创建共享网关，开启网管服务，还可以配置受限客户端
   - 再去创建 nfs 共享，选择桶、配置白名单
2. 配置共享网关：节点名称、网关和端口、状态、共享资源数、客户端连接数
3. nfs 共享分两步：选择桶、配置白名单：
   - 选择桶：选择用户、选择用户所有桶还是指定单个桶、如果是指定桶选择桶、选择网关节点、是否只读
   - 配置白名单：选择受限客户端、表格展示客户端昵称、客户端 IP/网段、权限
4. nfs 共享表格：桶 UID、网关个数、选择或者新增受限客户端个数、读写权限、状态启用/禁用
